name: prod-smoke
on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
jobs:
  http-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Check backend /health
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/health
          method: GET
          failOnErrorStatusCode: true

      - name: Check backend /ready
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/ready
          method: GET
          failOnErrorStatusCode: true

      - name: Check /metrics contains required series
        id: metrics
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/metrics
          method: GET
      - name: Assert metrics keys
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ steps.metrics.outputs.response }}`;
            const must = ['jobs_status_total', 'idempotency_conflicts_total', 'webhook_delivery_latency_seconds'];
            for (const key of must) {
              if (!body.includes(key)) {
                core.setFailed(`Missing metric: ${key}`);
              }
            }

      - name: Create test job for ETag validation
        id: create_job
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/jobs
          method: POST
          customHeaders: '{"Content-Type":"application/json"}'
          data: '{"urls":["https://httpbin.org/image/png"]}'

      - name: ETag /status — first request
        id: status1
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/jobs/${{ fromJson(steps.create_job.outputs.response).job_id }}
          method: GET
          customHeaders: '{"Cache-Control":"no-store"}'

      - name: ETag /status — second request (If-None-Match)
        id: status2
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/jobs/${{ fromJson(steps.create_job.outputs.response).job_id }}
          method: GET
          customHeaders: '{"If-None-Match":"${{ steps.status1.outputs.headers.etag }}"}'
          expectedStatusCode: 304

      - name: Test idempotency conflict
        id: idempotency_test
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/jobs
          method: POST
          customHeaders: '{"Content-Type":"application/json","Idempotency-Key":"smoke-test-key"}'
          data: '{"urls":["https://httpbin.org/image/jpeg"]}'

      - name: Test idempotency conflict (different body)
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.BACKEND_URL }}/jobs
          method: POST
          customHeaders: '{"Content-Type":"application/json","Idempotency-Key":"smoke-test-key"}'
          data: '{"urls":["https://httpbin.org/image/png"]}'
          expectedStatusCode: 409

      - name: Validate error format
        uses: actions/github-script@v7
        with:
          script: |
            const response = await fetch('${{ secrets.BACKEND_URL }}/jobs/nonexistent');
            const data = await response.json();
            
            const required = ['error_code', 'user_message', 'request_id', 'timestamp'];
            for (const field of required) {
              if (!data[field]) {
                core.setFailed(`Missing error field: ${field}`);
              }
            }
            
            if (data.error_code !== 'JOB_NOT_FOUND') {
              core.setFailed(`Expected JOB_NOT_FOUND, got: ${data.error_code}`);
            }
